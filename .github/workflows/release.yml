name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyqt5 pytest

      - name: Compile Qt resources
        run: pyrcc5 -o resources.py resources.qrc

      - name: Run unit tests
        # Only run the pure-Python unit test; the others require a live QGIS instance
        run: python -m pytest test/test_inventory_processor_unit.py -v

      - name: Build plugin ZIP
        run: |
          PLUGIN=MetadataManager
          mkdir -p staging/$PLUGIN

          # Root-level Python source files
          cp __init__.py MetadataManager.py MetadataManager_dockwidget.py \
             fix_metadata_status.py resources.py staging/$PLUGIN/

          # UI and static assets
          cp MetadataManager_dockwidget_base.ui metadata.txt icon.png \
             resources.qrc README.md staging/$PLUGIN/

          # Subdirectory packages
          cp -r db processors widgets staging/$PLUGIN/

          # Supporting directories
          cp -r icons i18n staging/$PLUGIN/

          # Strip any __pycache__ that crept into subdirs
          find staging/$PLUGIN -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true

          cd staging
          zip -r ../MetadataManager.zip $PLUGIN/

      - name: Extract changelog entry
        run: |
          TAG=${{ github.ref_name }}
          VERSION=${TAG#v}   # strip leading 'v'
          # Use index() for literal string match â€” avoids bracket regex issues
          HEADER="## [$VERSION]"
          awk -v hdr="$HEADER" '
            index($0, hdr) == 1 { found=1; next }
            /^## \[/ && found   { exit }
            found               { print }
          ' docs/CHANGELOG.md > release_notes.md
          # Fallback if version not found in changelog
          [ -s release_notes.md ] || echo "See [CHANGELOG.md](docs/CHANGELOG.md) for details." > release_notes.md

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "Metadata Manager ${{ github.ref_name }}" \
            --notes-file release_notes.md \
            MetadataManager.zip
